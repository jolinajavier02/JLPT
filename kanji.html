<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learn Kanji - NihongoMastery</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Noto+Sans+JP:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            overflow-x: hidden;
            min-height: 100vh;
            background: #f8f9fa;
        }

        /* Grid View (Scrollable) */
        .grid-view {
            min-height: 100vh;
            overflow-y: auto;
            padding: 80px 1rem 4rem;
            display: none;
            background: white;
        }

        .grid-view.active {
            display: block;
        }

        /* Detail View (Fixed Single Card) */
        .detail-view {
            display: none;
            height: 100vh;
            width: 100vw;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
        }

        .detail-view.active {
            display: flex;
        }

        .detail-card {
            background: white;
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            width: 95%;
            max-width: 1000px;
            height: 90vh;
            max-height: 700px;
            display: grid;
            grid-template-columns: 35% 65%;
            /* Left: Kanji, Right: Info */
            grid-template-rows: 1fr;
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        /* Left Column: Kanji Display */
        .card-left {
            background: var(--primary-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            padding: 2rem;
            position: relative;
        }

        .detail-char {
            font-size: 12rem;
            font-family: var(--font-jp);
            font-weight: 700;
            line-height: 1;
        }

        .detail-meaning {
            font-size: 2.5rem;
            font-weight: 800;
            margin-top: 1rem;
            text-align: center;
            text-transform: capitalize;
        }

        /* Right Column: Info & Interactive */
        .card-right {
            padding: 2rem;
            display: grid;
            grid-template-rows: auto 1fr auto;
            gap: 1.5rem;
            overflow-y: auto;
        }

        /* Readings Section */
        .readings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .reading-box {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 12px;
            border-left: 4px solid var(--accent-color);
        }

        .reading-label {
            font-size: 0.75rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.25rem;
            display: block;
        }

        .reading-value {
            font-size: 1.1rem;
            color: var(--text-color);
            font-weight: 600;
            font-family: var(--font-jp);
        }

        /* Origin & Writing Grid */
        .visual-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            height: 100%;
        }

        /* Origin/Mnemonic Box */
        .origin-box {
            background: #fff5f5;
            border: 1px solid #ffcdd2;
            border-radius: 16px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .origin-img-placeholder {
            width: 100%;
            height: 120px;
            background: white;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px dashed #ffcdd2;
            overflow: hidden;
        }

        .origin-img-placeholder svg {
            width: 100%;
            height: 100%;
        }

        .origin-text {
            font-size: 0.9rem;
            color: #555;
            line-height: 1.4;
        }

        /* Stroke Order Box */
        .stroke-box {
            background: white;
            border: 2px dashed #ddd;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .stroke-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stroke-placeholder svg {
            width: 80%;
            height: 80%;
        }

        .stroke-placeholder path {
            stroke: var(--primary-color) !important;
            stroke-width: 4 !important;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: draw 2s linear forwards;
        }

        @keyframes draw {
            to {
                stroke-dashoffset: 0;
            }
        }

        /* Navigation */
        .card-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }

        .nav-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            transition: 0.2s;
            padding: 0.5rem;
        }

        .nav-btn:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }

        .close-btn {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: 0.2s;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        /* Search & Grid Styles (Reused) */
        .kanji-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .kanji-card {
            background: white;
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-family: var(--font-jp);
            font-weight: 700;
        }

        .kanji-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
            background: var(--primary-color);
            color: white;
        }

        .search-container {
            max-width: 600px;
            margin: 0 auto 2rem;
        }

        .search-input {
            width: 100%;
            padding: 1rem 1.5rem;
            border-radius: 50px;
            border: 2px solid #eee;
            font-size: 1rem;
            outline: none;
        }

        .search-input:focus {
            border-color: var(--primary-color);
        }

        .load-more-btn {
            display: block;
            margin: 3rem auto;
            background: var(--primary-color);
            border: none;
            color: white;
            padding: 1rem 3rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-md);
        }

        .load-more-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Responsive */
        @media (max-width: 900px) {
            .detail-card {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
                height: 95vh;
                overflow-y: auto;
            }

            .card-left {
                padding: 1.5rem;
                flex-direction: row;
                gap: 1rem;
                justify-content: flex-start;
            }

            .detail-char {
                font-size: 4rem;
            }

            .detail-meaning {
                font-size: 1.5rem;
                margin: 0;
            }

            .visual-grid {
                grid-template-columns: 1fr;
            }

            .close-btn {
                color: var(--text-color);
                top: 1rem;
                right: 1rem;
                background: #eee;
            }
        }
    </style>
</head>

<body>

    <header class="main-header">
        <div class="container">
            <nav>
                <a href="home.html" class="logo">NihongoMastery</a>
                <div class="nav-links">
                    <a href="home.html" class="nav-link">Dashboard</a>
                    <a href="test.html" class="header-btn">Take Test</a>
                </div>
            </nav>
        </div>
    </header>

    <!-- Grid View -->
    <div id="grid-view" class="grid-view active">
        <div class="container">
            <div style="text-align: center; margin-bottom: 2rem;">
                <h1>Kanji Library</h1>
                <p>Explore all 2,136 Joyo Kanji</p>
            </div>

            <div class="search-container">
                <input type="text" id="kanji-search" class="search-input"
                    placeholder="Search Kanji (e.g., 山, Mountain)..." oninput="filterKanji()">
            </div>

            <div id="loading-indicator" class="loading-spinner" style="margin: 2rem auto;"></div>
            <div class="kanji-grid" id="kanji-grid"></div>
            <button id="load-more" class="load-more-btn" onclick="loadMoreKanji()" style="display: none;">Load
                More</button>
        </div>
    </div>

    <!-- Detail View (Single Card Overlay) -->
    <div id="detail-view" class="detail-view">
        <div class="detail-card">

            <!-- Left: Character -->
            <div class="card-left">
                <span id="detail-char" class="detail-char">?</span>
                <span id="detail-meaning" class="detail-meaning">Loading...</span>
                <button class="close-btn" onclick="showGrid()">✕</button>
            </div>

            <!-- Right: Info -->
            <div class="card-right">

                <!-- Readings -->
                <div class="readings-grid">
                    <div class="reading-box">
                        <span class="reading-label">Onyomi</span>
                        <div id="detail-onyomi" class="reading-value">-</div>
                    </div>
                    <div class="reading-box">
                        <span class="reading-label">Kunyomi</span>
                        <div id="detail-kunyomi" class="reading-value">-</div>
                    </div>
                </div>

                <!-- Visuals -->
                <div class="visual-grid">
                    <!-- Origin / Mnemonic -->
                    <div class="origin-box">
                        <span class="reading-label" style="color: var(--primary-color); margin-bottom: 0.5rem;">Origin /
                            Mnemonic</span>
                        <div class="origin-img-placeholder" id="origin-img">
                            <!-- SVG or Image goes here -->
                            <span style="color: #ccc; font-size: 0.8rem;">Visual Coming Soon</span>
                        </div>
                        <p id="detail-origin" class="origin-text">No mnemonic available.</p>
                    </div>

                    <!-- Writing Pattern -->
                    <div class="stroke-box">
                        <span class="reading-label" style="position: absolute; top: 0.5rem; left: 1rem;">Writing
                            Pattern</span>
                        <div class="stroke-placeholder" id="stroke-container">
                            Loading...
                        </div>
                        <button class="btn"
                            style="position: absolute; bottom: 0.5rem; right: 0.5rem; padding: 0.25rem 0.75rem; font-size: 0.7rem;"
                            onclick="replayAnimation()">Replay</button>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="card-nav">
                    <button class="nav-btn" onclick="prevChar()">← Previous</button>
                    <button class="nav-btn" onclick="nextChar()">Next →</button>
                </div>

            </div>
        </div>
    </div>

    <script>
        // State
        let allKanjiList = [];
        let displayedCount = 0;
        const BATCH_SIZE = 100;
        let currentKanjiIndex = 0;

        // Kana Map (Same as before)
        const kanaMap = {
            'あ': 'a', 'い': 'i', 'う': 'u', 'え': 'e', 'お': 'o', 'か': 'ka', 'き': 'ki', 'く': 'ku', 'け': 'ke', 'こ': 'ko',
            'さ': 'sa', 'し': 'shi', 'す': 'su', 'せ': 'se', 'そ': 'so', 'た': 'ta', 'ち': 'chi', 'つ': 'tsu', 'て': 'te', 'と': 'to',
            'な': 'na', 'に': 'ni', 'ぬ': 'nu', 'ね': 'ne', 'の': 'no', 'は': 'ha', 'ひ': 'hi', 'ふ': 'fu', 'へ': 'he', 'ほ': 'ho',
            'ま': 'ma', 'み': 'mi', 'む': 'mu', 'め': 'me', 'も': 'mo', 'や': 'ya', 'ゆ': 'yu', 'よ': 'yo',
            'ら': 'ra', 'り': 'ri', 'る': 'ru', 'れ': 're', 'ろ': 'ro', 'わ': 'wa', 'を': 'wo', 'ん': 'n',
            'が': 'ga', 'ぎ': 'gi', 'ぐ': 'gu', 'げ': 'ge', 'ご': 'go', 'ざ': 'za', 'じ': 'ji', 'ず': 'zu', 'ぜ': 'ze', 'ぞ': 'zo',
            'だ': 'da', 'ぢ': 'ji', 'づ': 'zu', 'で': 'de', 'ど': 'do', 'ば': 'ba', 'び': 'bi', 'ぶ': 'bu', 'べ': 'be', 'ぼ': 'bo',
            'ぱ': 'pa', 'ぴ': 'pi', 'ぷ': 'pu', 'ぺ': 'pe', 'ぽ': 'po', 'きゃ': 'kya', 'きゅ': 'kyu', 'きょ': 'kyo',
            'しゃ': 'sha', 'しゅ': 'shu', 'しょ': 'sho', 'ちゃ': 'cha', 'ちゅ': 'chu', 'ちょ': 'cho',
            'にゃ': 'nya', 'にゅ': 'nyu', 'にょ': 'nyo', 'ひゃ': 'hya', 'ひゅ': 'hyu', 'ひょ': 'hyo',
            'みゃ': 'mya', 'みゅ': 'myu', 'みょ': 'myo', 'りゃ': 'rya', 'りゅ': 'ryu', 'りょ': 'ryo',
            'ぎゃ': 'gya', 'ぎゅ': 'gyu', 'ぎょ': 'gyo', 'じゃ': 'ja', 'じゅ': 'ju', 'じょ': 'jo',
            'びゃ': 'bya', 'びゅ': 'byu', 'びょ': 'byo', 'ぴゃ': 'pya', 'ぴゅ': 'pyu', 'ぴょ': 'pyo',
            'ア': 'a', 'イ': 'i', 'ウ': 'u', 'エ': 'e', 'オ': 'o', 'カ': 'ka', 'キ': 'ki', 'ク': 'ku', 'ケ': 'ke', 'コ': 'ko',
            'サ': 'sa', 'シ': 'shi', 'ス': 'su', 'セ': 'se', 'ソ': 'so', 'タ': 'ta', 'チ': 'chi', 'ツ': 'tsu', 'テ': 'te', 'ト': 'to',
            'ナ': 'na', 'ニ': 'ni', 'ヌ': 'nu', 'ネ': 'ne', 'ノ': 'no', 'ハ': 'ha', 'ヒ': 'hi', 'フ': 'fu', 'ヘ': 'he', 'ホ': 'ho',
            'マ': 'ma', 'ミ': 'mi', 'ム': 'mu', 'メ': 'me', 'モ': 'mo', 'ヤ': 'ya', 'ユ': 'yu', 'ヨ': 'yo',
            'ラ': 'ra', 'リ': 'ri', 'ル': 'ru', 'レ': 're', 'ロ': 'ro', 'ワ': 'wa', 'ヲ': 'wo', 'ン': 'n',
            'ガ': 'ga', 'ギ': 'gi', 'グ': 'gu', 'ゲ': 'ge', 'ゴ': 'go', 'ザ': 'za', 'ジ': 'ji', 'ズ': 'zu', 'ゼ': 'ze', 'ゾ': 'zo',
            'ダ': 'da', 'ヂ': 'ji', 'ヅ': 'zu', 'デ': 'de', 'ド': 'do', 'バ': 'ba', 'ビ': 'bi', 'ブ': 'bu', 'ベ': 'be', 'ボ': 'bo',
            'パ': 'pa', 'ピ': 'pi', 'プ': 'pu', 'ペ': 'pe', 'ポ': 'po', 'キャ': 'kya', 'キュ': 'kyu', 'キョ': 'kyo',
            'シャ': 'sha', 'シュ': 'shu', 'ショ': 'sho', 'チャ': 'cha', 'チュ': 'chu', 'チョ': 'cho',
            'ニャ': 'nya', 'ニュ': 'nyu', 'ニョ': 'nyo', 'ヒャ': 'hya', 'ヒュ': 'hyu', 'ヒョ': 'hyo',
            'ミャ': 'mya', 'ミュ': 'myu', 'ミョ': 'myo', 'リャ': 'rya', 'リュ': 'ryu', 'リョ': 'ryo',
            'ギャ': 'gya', 'ギュ': 'gyu', 'ギョ': 'gyo', 'ジャ': 'ja', 'ジュ': 'ju', 'ジョ': 'jo',
            'ビャ': 'bya', 'ビュ': 'byu', 'ビョ': 'byo', 'ピャ': 'pya', 'ピュ': 'pyu', 'ピョ': 'pyo',
            'ッ': '(pause)', 'っ': '(pause)', 'ー': '-'
        };

        function toRomaji(text) {
            if (!text) return '';
            let romaji = '';
            let i = 0;
            while (i < text.length) {
                if (i + 1 < text.length) {
                    const two = text.substring(i, i + 2);
                    if (kanaMap[two]) { romaji += kanaMap[two]; i += 2; continue; }
                }
                const char = text[i];
                romaji += kanaMap[char] ? kanaMap[char] : char;
                i++;
            }
            return romaji;
        }

        // Local Data with SVGs - N5 Kanji Origins & Mnemonics
        const localKanjiData = {
            // Numbers
            '一': { origin: "Represents one finger held up, or a single line.", svg: `<svg viewBox="0 0 100 100"><line x1="20" y1="50" x2="80" y2="50" stroke="#333" stroke-width="8" stroke-linecap="round"/></svg>` },
            '二': { origin: "Two lines representing the number two.", svg: `<svg viewBox="0 0 100 100"><line x1="30" y1="35" x2="70" y2="35" stroke="#333" stroke-width="8"/><line x1="20" y1="65" x2="80" y2="65" stroke="#333" stroke-width="8"/></svg>` },
            '三': { origin: "Three lines representing the number three.", svg: `<svg viewBox="0 0 100 100"><line x1="30" y1="25" x2="70" y2="25" stroke="#333" stroke-width="8"/><line x1="40" y1="50" x2="60" y2="50" stroke="#333" stroke-width="8"/><line x1="20" y1="75" x2="80" y2="75" stroke="#333" stroke-width="8"/></svg>` },
            '四': { origin: "Originally a pictograph of a nose breathing (two lines inside a mouth). Later borrowed for 'four'." },
            '五': { origin: "Originally an X, representing crossing numbers. Later added lines to look like a spool of thread." },
            '六': { origin: "A pictograph of a hut or tent. Borrowed for the number six." },
            '七': { origin: "A cut line. The vertical line cuts the horizontal one. Represents the number seven." },
            '八': { origin: "Two lines dividing or separating. Represents the number eight.", svg: `<svg viewBox="0 0 100 100"><path d="M50 20 L20 80 M50 20 L80 80" fill="none" stroke="#333" stroke-width="6"/></svg>` },
            '九': { origin: "A pictograph of a bent arm showing muscle. Borrowed for nine." },
            '十': { origin: "A needle (vertical) piercing a bead (horizontal). Represents ten or completeness.", svg: `<svg viewBox="0 0 100 100"><line x1="10" y1="50" x2="90" y2="50" stroke="#333" stroke-width="8"/><line x1="50" y1="10" x2="50" y2="90" stroke="#333" stroke-width="8"/></svg>` },
            '百': { origin: "One (一) white (白) thumb. Represents a hundred." },
            '千': { origin: "A person (人) with a line through it, representing a thousand people." },
            '万': { origin: "A scorpion. Borrowed for ten thousand because scorpions swarm in large numbers." },

            // Nature & Elements
            '日': { origin: "A pictograph of the sun. Originally a circle with a dot inside.", svg: `<svg viewBox="0 0 100 100"><rect x="25" y="20" width="50" height="60" fill="none" stroke="#ff9800" stroke-width="6"/><line x1="25" y1="50" x2="75" y2="50" stroke="#ff9800" stroke-width="6"/></svg>` },
            '月': { origin: "A pictograph of a crescent moon with clouds passing in front.", svg: `<svg viewBox="0 0 100 100"><path d="M30 10 Q20 50 30 90 Q60 90 60 60 Q60 30 30 10 M30 40 L60 40 M30 60 L60 60" fill="none" stroke="#333" stroke-width="6"/></svg>` },
            '火': { origin: "A pictograph of flames rising from a fire.", svg: `<svg viewBox="0 0 100 100"><path d="M20 80 Q30 50 20 20 M80 80 Q70 50 80 20 M50 20 L40 60 L60 60 Z" fill="none" stroke="#e53935" stroke-width="4"/></svg>` },
            '水': { origin: "A pictograph of flowing water. The center line is the stream, sides are ripples.", svg: `<svg viewBox="0 0 100 100"><path d="M50 10 L50 90 M20 30 Q30 50 20 80 M80 20 Q70 50 80 70" fill="none" stroke="#1e88e5" stroke-width="5"/></svg>` },
            '木': { origin: "A pictograph of a tree with branches and roots.", svg: `<svg viewBox="0 0 100 100"><line x1="50" y1="10" x2="50" y2="90" stroke="#4caf50" stroke-width="6"/><line x1="20" y1="40" x2="80" y2="40" stroke="#4caf50" stroke-width="6"/><line x1="50" y1="40" x2="20" y2="90" stroke="#4caf50" stroke-width="6"/><line x1="50" y1="40" x2="80" y2="90" stroke="#4caf50" stroke-width="6"/></svg>` },
            '金': {
                origin: "Gold/Metal. A roof (top), layers of earth (lines), and nuggets of gold (dots) buried underneath. Like a king's treasure.",
                imageUrl: "https://raw.githubusercontent.com/kanjialive/kanji-data-media/master/language-data/ka/金.png"
            },
            '土': { origin: "A sprout growing out of the ground.", svg: `<svg viewBox="0 0 100 100"><line x1="20" y1="80" x2="80" y2="80" stroke="#795548" stroke-width="6"/><line x1="50" y1="80" x2="50" y2="30" stroke="#795548" stroke-width="6"/><line x1="30" y1="50" x2="70" y2="50" stroke="#795548" stroke-width="6"/></svg>` },
            '山': { origin: "A pictograph of a mountain with three peaks.", svg: `<svg viewBox="0 0 100 100"><path d="M20 70 L20 40 L50 10 L80 40 L80 70 Z" fill="none" stroke="#333" stroke-width="5"/></svg>` },
            '川': { origin: "A pictograph of a flowing river with three streams.", svg: `<svg viewBox="0 0 100 100"><path d="M25 10 Q35 50 25 90 M50 10 Q60 50 50 90 M75 10 Q85 50 75 90" fill="none" stroke="#2196f3" stroke-width="5"/></svg>` },
            '田': { origin: "A pictograph of a rice field divided into four plots.", svg: `<svg viewBox="0 0 100 100"><rect x="20" y="20" width="60" height="60" fill="none" stroke="#333" stroke-width="5"/><line x1="50" y1="20" x2="50" y2="80" stroke="#333" stroke-width="5"/><line x1="20" y1="50" x2="80" y2="50" stroke="#333" stroke-width="5"/></svg>` },
            '雨': { origin: "Rain falling from a cloud (top line) through a window (box)." },
            '空': { origin: "A hole (穴) + Work (工). The vast empty space above where work is done." },
            '天': { origin: "A person (大) with a line above their head, representing the sky/heavens." },

            // People & Body
            '人': { origin: "A pictograph of a person standing sideways.", svg: `<svg viewBox="0 0 100 100"><path d="M50 20 L20 80 M50 20 L80 80" fill="none" stroke="#333" stroke-width="6"/></svg>` },
            '口': { origin: "A pictograph of an open mouth.", svg: `<svg viewBox="0 0 100 100"><rect x="25" y="30" width="50" height="40" fill="none" stroke="#333" stroke-width="6"/></svg>` },
            '目': { origin: "A pictograph of an eye turned vertically.", svg: `<svg viewBox="0 0 100 100"><rect x="30" y="20" width="40" height="60" fill="none" stroke="#333" stroke-width="5"/><line x1="30" y1="40" x2="70" y2="40" stroke="#333" stroke-width="5"/><line x1="30" y1="60" x2="70" y2="60" stroke="#333" stroke-width="5"/></svg>` },
            '耳': { origin: "A pictograph of an ear." },
            '手': { origin: "A pictograph of a hand with five fingers." },
            '足': { origin: "A mouth (口) + a person stopping (止). The foot is used to stop." },
            '力': { origin: "A pictograph of a flexing arm/muscle showing strength." },
            '女': { origin: "A pictograph of a kneeling woman." },
            '男': { origin: "Rice field (田) + Power (力). Men worked powerfully in the fields." },
            '子': { origin: "A pictograph of a baby with a large head and waving arms." },
            '父': { origin: "A hand holding a stone axe. The father is the leader/worker." },
            '母': { origin: "A woman (女) with two dots representing breasts for nursing." },

            // Directions & Locations
            '上': { origin: "A line above a baseline. Indicates 'up'.", svg: `<svg viewBox="0 0 100 100"><line x1="20" y1="80" x2="80" y2="80" stroke="#333" stroke-width="6"/><line x1="50" y1="80" x2="50" y2="20" stroke="#333" stroke-width="6"/><line x1="50" y1="40" x2="80" y2="40" stroke="#333" stroke-width="6"/></svg>` },
            '下': { origin: "A line below a baseline. Indicates 'down'.", svg: `<svg viewBox="0 0 100 100"><line x1="20" y1="20" x2="80" y2="20" stroke="#333" stroke-width="6"/><line x1="50" y1="20" x2="50" y2="80" stroke="#333" stroke-width="6"/><line x1="50" y1="60" x2="80" y2="60" stroke="#333" stroke-width="6"/></svg>` },
            '中': { origin: "A line passing through the center of a circle/square.", svg: `<svg viewBox="0 0 100 100"><rect x="25" y="30" width="50" height="40" fill="none" stroke="#333" stroke-width="5"/><line x1="50" y1="10" x2="50" y2="90" stroke="#333" stroke-width="5"/></svg>` },
            '外': { origin: "Evening (夕) + Divination (卜). Divination was done outside in the evening." },
            '右': { origin: "Hand (no) + Mouth (口). The hand used to eat (right hand)." },
            '左': { origin: "Hand (no) + Work (工). The hand used to hold tools (left hand)." },
            '北': { origin: "Two people sitting back to back. Cold wind comes from the North." },
            '西': { origin: "A bird returning to its nest at sunset (West)." },
            '南': { origin: "A lush plant growing in the warm South." },
            '東': { origin: "Sun (日) rising behind a Tree (木). The East." },

            // Verbs & Actions
            '見': { origin: "Eye (目) + Legs (儿). An eye on legs, going to see." },
            '聞': { origin: "Ear (耳) inside a Gate (門). Listening through the door to hear." },
            '言': { origin: "Words coming out of a mouth (口)." },
            '話': { origin: "Words (言) + Tongue (舌). Speaking with the tongue." },
            '読': { origin: "Words (言) + Sell (売). Reading aloud was like selling words." },
            '書': { origin: "A hand holding a brush writing on paper." },
            '食': { origin: "A person (人) + Good (良). Eating good food." },
            '飲': { origin: "Eat (食) + Yawn (欠). Opening mouth to drink." },
            '行': { origin: "A crossroad. To go." },
            '来': { origin: "A wheat plant. Wheat came from across the sea." },
            '出': { origin: "Something emerging from a container. To exit/come out." },
            '入': { origin: "An arrow entering a target. To enter." },
            '立': { origin: "A person standing on the ground." },
            '休': { origin: "A person (人) leaning against a tree (木) to rest." },

            // Adjectives & States
            '大': { origin: "A person stretching arms and legs wide. Big.", svg: `<svg viewBox="0 0 100 100"><path d="M50 20 L20 80 M50 20 L80 80 M20 40 L80 40" fill="none" stroke="#333" stroke-width="6"/></svg>` },
            '小': { origin: "Three small dots/grains. Small.", svg: `<svg viewBox="0 0 100 100"><line x1="50" y1="20" x2="50" y2="80" stroke="#333" stroke-width="6"/><circle cx="30" cy="50" r="5" fill="#333"/><circle cx="70" cy="50" r="5" fill="#333"/></svg>` },
            '高': { origin: "A tall tower or building. High/Expensive." },
            '安': { origin: "A woman (女) under a roof (宀). Peaceful and cheap." },
            '新': { origin: "Stand (立) + Tree (木) + Axe (斤). Cutting a tree to make something new." },
            '古': { origin: "Ten (十) + Mouth (口). A story told for ten generations is old." },
            '多': { origin: "Two moons (夕). Many nights passed." },
            '少': { origin: "Small (小) + a slash. Cutting something small makes it fewer." },
            '長': { origin: "Long hair flowing down. Long." },
            '白': { origin: "The sun (日) with a ray coming out. White/Bright." },
            '赤': { origin: "Earth (土) + Fire (火). Red hot earth." },
            '青': { origin: "Growing plants. Blue/Green (young color)." },
            '黒': { origin: "Soot from fire. Black." },

            // Time
            '今': { origin: "A lid closing now. The present moment." },
            '年': { origin: "A person carrying grain on their back. Annual harvest." },
            '毎': { origin: "A mother (母) with decorative marks. Every (day she works)." },
            '朝': { origin: "Moon (月) + Sun (日) + Plants. Morning when sun rises." },
            '昼': { origin: "Sun (日) at its highest. Noon/Daytime." },
            '夜': { origin: "Person (人) under a roof at night. Night." },
            '前': { origin: "A boat moving forward. Before/Front." },
            '後': { origin: "A person walking behind. After/Back." },

            // Learning & School
            '学': { origin: "A child (子) under a roof (宀) with learning symbols. Study." },
            '校': { origin: "Tree (木) + Exchange (交). A school where knowledge is exchanged." },
            '先': { origin: "A cow (牛) + legs (儿). The cow leads ahead. Before/Teacher." },
            '生': { origin: "A plant sprouting from the ground. Life/Birth." },
            '本': { origin: "Tree (木) with a mark at the base. Origin/Book." },
            '名': { origin: "Evening (夕) + Mouth (口). Calling someone's name in the dark." },
            '字': { origin: "A child (子) under a roof (宀). Written character." }
        };

        document.addEventListener('DOMContentLoaded', () => { fetchJoyoKanji(); });

        async function fetchJoyoKanji() {
            try {
                const response = await fetch('https://kanjiapi.dev/v1/kanji/joyo');
                allKanjiList = await response.json();
                document.getElementById('loading-indicator').style.display = 'none';
                loadMoreKanji();
            } catch (error) {
                console.error(error);
            }
        }

        function loadMoreKanji() {
            const grid = document.getElementById('kanji-grid');
            const nextBatch = allKanjiList.slice(displayedCount, displayedCount + BATCH_SIZE);
            nextBatch.forEach(char => {
                const card = document.createElement('div');
                card.className = 'kanji-card';
                card.innerHTML = `<span class="kanji-char">${char}</span>`;
                card.onclick = () => openDetail(char);
                grid.appendChild(card);
            });
            displayedCount += nextBatch.length;
            document.getElementById('load-more').style.display = displayedCount < allKanjiList.length ? 'block' : 'none';
        }

        function filterKanji() {
            const query = document.getElementById('kanji-search').value.toLowerCase();
            const grid = document.getElementById('kanji-grid');
            if (!query) { grid.innerHTML = ''; displayedCount = 0; loadMoreKanji(); return; }
            if (allKanjiList.includes(query)) {
                grid.innerHTML = '';
                const card = document.createElement('div');
                card.className = 'kanji-card';
                card.innerHTML = `<span class="kanji-char">${query}</span>`;
                card.onclick = () => openDetail(query);
                grid.appendChild(card);
                document.getElementById('load-more').style.display = 'none';
            }
        }

        async function openDetail(char) {
            currentKanjiIndex = allKanjiList.indexOf(char);
            document.getElementById('grid-view').classList.remove('active');
            document.getElementById('detail-view').classList.add('active');

            document.getElementById('detail-char').textContent = char;
            document.getElementById('detail-meaning').textContent = 'Loading...';

            try {
                const response = await fetch(`https://kanjiapi.dev/v1/kanji/${char}`);
                const data = await response.json();

                document.getElementById('detail-meaning').textContent = data.meanings.join(', ');

                const onRomaji = data.on_readings.map(r => `${r} (${toRomaji(r)})`).join(', ');
                const kunRomaji = data.kun_readings.map(r => `${r} (${toRomaji(r)})`).join(', ');
                document.getElementById('detail-onyomi').textContent = onRomaji || '-';
                document.getElementById('detail-kunyomi').textContent = kunRomaji || '-';

                const local = localKanjiData[char];
                const originText = document.getElementById('detail-origin');
                const originImg = document.getElementById('origin-img');

                if (local) {
                    originText.textContent = local.origin;

                    // Priority: imageUrl > svg > placeholder
                    if (local.imageUrl) {
                        originImg.innerHTML = `<img src="${local.imageUrl}" alt="Mnemonic for ${char}" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.parentElement.innerHTML='<span style=\\'color: #ccc; font-size: 0.8rem;\\'>Image failed to load</span>'">`;
                    } else if (local.svg) {
                        originImg.innerHTML = local.svg;
                    } else {
                        originImg.innerHTML = '<span style="color: #ccc; font-size: 0.8rem;">Visual Coming Soon</span>';
                    }
                } else {
                    originText.textContent = "Origin data not available for this Kanji.";
                    originImg.innerHTML = '<span style="color: #ccc; font-size: 0.8rem;">No Visual Available</span>';
                }

                loadStrokeOrder(char);
            } catch (error) {
                console.error(error);
            }
        }

        function showGrid() {
            document.getElementById('detail-view').classList.remove('active');
            document.getElementById('grid-view').classList.add('active');
        }

        function nextChar() { if (currentKanjiIndex < allKanjiList.length - 1) openDetail(allKanjiList[currentKanjiIndex + 1]); }
        function prevChar() { if (currentKanjiIndex > 0) openDetail(allKanjiList[currentKanjiIndex - 1]); }

        function getUnicodeHex(char) {
            let hex = char.charCodeAt(0).toString(16);
            while (hex.length < 5) hex = "0" + hex;
            return hex;
        }

        function loadStrokeOrder(char) {
            const container = document.getElementById('stroke-container');
            container.innerHTML = '<span style="color: #ccc;">Loading...</span>';
            const hex = getUnicodeHex(char);
            const url = `https://raw.githubusercontent.com/KanjiVG/kanjivg/master/kanji/${hex}.svg`;

            fetch(url)
                .then(res => res.text())
                .then(svgData => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(svgData, "image/svg+xml");
                    const svgElement = doc.querySelector("svg");
                    if (svgElement) {
                        container.innerHTML = "";
                        container.appendChild(svgElement);
                        animateStrokes();
                    } else { container.innerHTML = "No animation"; }
                })
                .catch(() => container.innerHTML = "No animation");
        }

        function animateStrokes() {
            const paths = document.querySelectorAll('.stroke-placeholder path');
            paths.forEach((path, index) => {
                const length = path.getTotalLength();
                path.style.strokeDasharray = length;
                path.style.strokeDashoffset = length;
                path.style.animation = `draw 1s linear forwards ${index * 0.8}s`;
            });
        }

        function replayAnimation() {
            const container = document.getElementById('stroke-container');
            const svg = container.innerHTML;
            container.innerHTML = '';
            setTimeout(() => { container.innerHTML = svg; animateStrokes(); }, 10);
        }
    </script>
</body>

</html>